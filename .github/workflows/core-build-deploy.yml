name: CORE - Build (Deploy Optional)

on:
  workflow_dispatch:
    inputs:
      deploy:
        description: "Deploy after build? (true/false)"
        required: true
        default: "false"

# REQUIRED so github-actions can push commits
permissions:
  contents: write

jobs:
  core-build:
    runs-on: windows-latest

    steps:
      # ----------------------------
      # Checkout with push capability
      # ----------------------------
      - name: Checkout
        uses: actions/checkout@v3
        with:
          persist-credentials: true

      - name: Install Power Platform CLI
        uses: microsoft/powerplatform-actions/actions-install@v1

      - name: Create working folders
        run: |
          mkdir out
          mkdir src

      # ----------------------------
      # Export Unmanaged (Source Control)
      # ----------------------------
      - name: Export CORE Unmanaged
        uses: microsoft/powerplatform-actions/export-solution@v1
        with:
          environment-url: ${{ secrets.CORE_ENV_URL }}
          app-id: ${{ secrets.APP_ID }}
          client-secret: ${{ secrets.CLIENT_SECRET }}
          tenant-id: ${{ secrets.TENANT_ID }}
          solution-name: ALMCORE   # ensure this is the UNIQUE NAME
          managed: false
          solution-output-file: ALMCORE_unmanaged.zip
          working-directory: out

      - name: Unpack CORE
        uses: microsoft/powerplatform-actions/unpack-solution@v1
        with:
          solution-file: out/ALMCORE_unmanaged.zip
          solution-folder: src/ALMCORE
          solution-type: Unmanaged

      # ----------------------------
      # Commit to Source Control
      # ----------------------------
      - name: Commit Unpacked CORE
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add src
          git commit -m "Update ALMCORE source from CORE environment" || echo "No changes detected"
          git push

      # ----------------------------
      # Export Managed (Artifact)
      # ----------------------------
      - name: Export CORE Managed
        uses: microsoft/powerplatform-actions/export-solution@v1
        with:
          environment-url: ${{ secrets.CORE_ENV_URL }}
          app-id: ${{ secrets.APP_ID }}
          client-secret: ${{ secrets.CLIENT_SECRET }}
          tenant-id: ${{ secrets.TENANT_ID }}
          solution-name: ALMCORE
          managed: true
          solution-output-file: ALMCORE_managed.zip
          working-directory: out

      # ----------------------------
      # Optional Deployment Section
      # ----------------------------

      - name: Deploy CORE to DEV1
        if: ${{ github.event.inputs.deploy == 'true' }}
        uses: microsoft/powerplatform-actions/import-solution@v1
        with:
          environment-url: ${{ secrets.DEV1_ENV_URL }}
          app-id: ${{ secrets.APP_ID }}
          client-secret: ${{ secrets.CLIENT_SECRET }}
          tenant-id: ${{ secrets.TENANT_ID }}
          solution-file: out/ALMCORE_managed.zip
          publish-changes: true
          force-overwrite: true

      - name: Deploy CORE to DEV2
        if: ${{ github.event.inputs.deploy == 'true' }}
        uses: microsoft/powerplatform-actions/import-solution@v1
        with:
          environment-url: ${{ secrets.DEV2_ENV_URL }}
          app-id: ${{ secrets.APP_ID }}
          client-secret: ${{ secrets.CLIENT_SECRET }}
          tenant-id: ${{ secrets.TENANT_ID }}
          solution-file: out/ALMCORE_managed.zip
          publish-changes: true
          force-overwrite: true

      - name: Deploy CORE to TEST
        if: ${{ github.event.inputs.deploy == 'true' }}
        uses: microsoft/powerplatform-actions/import-solution@v1
        with:
          environment-url: ${{ secrets.TEST_ENV_URL }}
          app-id: ${{ secrets.APP_ID }}
          client-secret: ${{ secrets.CLIENT_SECRET }}
          tenant-id: ${{ secrets.TENANT_ID }}
          solution-file: out/ALMCORE_managed.zip
          publish-changes: true
          force-overwrite: true
